<!DOCTYPE html>
<html lang="en">
<head>
    <title>BlinkM Demo</title>
    {% include "include/rascal-head.html" %}
    <script src="/static/js/jquery.knob-1.2.0.js"></script>
    <script>
        var delay = (function () {
            var timer = 0;
            return function(callback, ms) {
                clearTimeout (timer);
                timer = setTimeout(callback, ms);
            };
        })();

        $(function () {
            $(".knob").knob( {
                change: function (value) {
                    delay(function () {
                        setValues();
                    }, 100);
                    // console.log("change : " + value);
                },
                release: function (value) {
                    setValues();
                    // console.log("release : " + value);
                },
                cancel: function () {
                    // console.log("cancel : " + this.value);
                },
                draw: function () {
                    if(this.$.data('skin') == 'tron') {

                        var a = this.angle(this.cv),    // Angle
                            sa = this.startAngle,       // Previous start angle
                            sat = this.startAngle,      // Start angle
                            ea,                         // Previous end angle
                            eat = sat + a,              // End angle
                            r = 1;
                        
                        this.g.lineWidth = this.lineWidth;
                        
                        this.o.cursor
                            && (sat = eat - 0.3)
                            && (eat = eat + 0.3);
                        
                        if (this.o.displayPrevious) {
                            ea = this.startAngle + this.angle(this.v);
                            this.o.cursor
                                && (sa = ea - 0.3)
                                && (ea = ea + 0.3);
                            this.g.beginPath();
                            this.g.strokeStyle = this.pColor;
                            this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, sa, ea, false);
                            this.g.stroke();
                        }
                        
                        this.g.beginPath();
                        this.g.strokeStyle = r ? this.o.fgColor : this.fgColor ;
                        this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, sat, eat, false);
                        this.g.stroke();
                        
                        this.g.lineWidth = 2;
                        this.g.beginPath();
                        this.g.strokeStyle = this.o.fgColor;
                        this.g.arc( this.xy, this.xy, this.radius - this.lineWidth + 1 + this.lineWidth * 2 / 3, 0, 2 * Math.PI, false);
                        this.g.stroke();
                        
                        return false;
                    }
                }
            });
        });
    </script>
    <style>
        .well.knobset {
            margin: 10px 0;
            color: #F8F8F8;
            background-color: #222;
            border-color: #444;
            width: 460px;
        }
    </style>
</head>
<body>
    {% include "include/rascal-topbar.html" %}
    <div class="container">
        <div class="well rascal">
            <h1>BlinkM LED alt demo</h1>
            <div class="well knobset">
                <input id="knob_red" class="knob" data-width="150" data-height="150" data-displayPrevious="true"
                    data-fgColor="#ee4444" data-skin="tron" data-thickness=".2" data-max="255" value="0">
                <input id="knob_green" class="knob" data-width="150" data-height="150" data-displayPrevious="true"
                    data-fgColor="#55ee55" data-skin="tron" data-thickness=".2" data-max="255" value="0">
                <input id="knob_blue" class="knob" data-width="150" data-height="150" data-displayPrevious="true"
                    data-fgColor="#6666ee" data-skin="tron" data-thickness=".2" data-max="255" value="0">
            </div>
        </div>
    </div>
    <!-- {% include "include/doc-tab.html" %} --> 
    <script type="text/javascript">
        var initialising = false;
        
        function writeToBlinkM(params) {
            $.post('/i2c_write', { params: JSON.stringify(params) }, function (response) {
                var result = JSON.parse(response);
                // console.log (response);
                if (result['success']) {
                    console.log('i2c_write: success');
                } else {
                    console.log('i2c_write: [' + result['errorCode'] + '] ' + result['errorMessage']);
                }
            }).error(function (jqXHR, textStatus, errorThrown) {
                console.log('i2c_write: ' + textStatus + ': ' + errorThrown);
            });
        }
        
        function stopScript() {
            var params = {
                addr: 0x09,
                reg: 0x6f,
                value: 0,
                size: 'C'
                };
            writeToBlinkM(params);
        }
        
        function setFadeSpeed(speed) {
            var params = {
                addr: 0x09,
                reg: 0x66,
                value: speed,
                size: 'B'
                };
            writeToBlinkM(params);
        }

        function fadeToRGB(r, g, b) {
            var params = {
                addr: 0x09,
                reg: 0x63,
                value: [r, g, b],
                size: 'I'
                };
            writeToBlinkM(params);
        }
        
        function getValue(which) {
            var value = parseInt($('#knob_' + which).val());
            if (value < 0) {
                return 0;
            } else if (value > 255) {
                return 255;
            }
            return value;
        }
        
        function setValues() {
            var r = getValue('red'),
                g = getValue('green'),
                b = getValue('blue');
            fadeToRGB(r, g, b);
        }

        $('input').change(function () {
            if (!initialising) {
                console.log('change ' + $(this).attr('id'));
                setValues();
            }
        });
        
        function getCurrentRGB () {
            var params = {
                addr: 0x09,
                reg: 0x67,
                size: 'I',
                length: 3
                },
                value;
            $.post('/i2c_read', { params: JSON.stringify(params) }, function (response) {
                var result = JSON.parse(response);
                console.log (response);
                if (result['success']) {
                    initialising = true;
                    console.log('i2c_read: success');
                    value = result['value'];
                    $('#knob_red')
                        .val(value[0])
                        .trigger('change');
                    $('#knob_green')
                        .val(value[1])
                        .trigger('change');
                    $('#knob_blue')
                        .val(value[2])
                        .trigger('change');
                    initialising = false;
                } else {
                    console.log('i2c_read: [' + result['errorCode'] + '] ' + result['errorMessage']);
                }
            }).error(function (jqXHR, textStatus, errorThrown) {
                console.log('i2c_read: ' + textStatus + ': ' + errorThrown);
            });            
        }

        $(document).ready(function() {
            stopScript();
            setFadeSpeed(10);
            getCurrentRGB();
        });
    </script>
</body>
</html>
