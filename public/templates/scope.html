<!DOCTYPE html>
<!-- 28 Dec 2011, 19-27 June 2012 dsmall -->
<!-- JSLint 7 Oct 2012 jQuery $ -->
<html lang="en">
<head>
    <title>Scope Demo</title>
    {% include "include/rascal-head.html" %}
    <style>
        .log-display {
            border: 2px solid #414243;
            color: lime;
            background-color: #333;
            font-family: 'VT323', 'Courier', sans-serif;
            font-size: 20px;
        }
        #chart1 {
            margin-top: 20px;
            margin-left: -40px;
            height: 400px;
            width: 800px;
        }
        .jqplot-title, .jqplot-axis {
            color: #ddd;
        }
    </style>
</head>
<body>
    {% include "include/rascal-topbar.html" %}
    <div class="container">
        <div class="well rascal">
            <h1>Scope demo on Rascal24</h1>
            <p>&nbsp;</p>
            <span class="log-display" id="strDate"></span>
            <span class="log-display" id="strTemp"></span>
            <span class="log-display" id="strLED"></span>
            <br />
            <div id="chart1" style=""></div>
            
            <p>Gain control:</p>
            <button id="gain_down" type="button" class="btn">Decrease</button>
            <button id="gain_up" type="button" class="btn">Increase</button>
        </div>
    </div>
    
    <script language="javascript" type="text/javascript">

        var chartOptions = {
            legend: {
                show: true,
                location: "nw"
            },
            title: "Channel 0",
            series: [
                { label: "Channel 0", lineWidth: 3, showMarker: false }
            ],
            axes: {
                xaxis: {
                    label: "Time [seconds ago]",
                    min: 0,
                    max: 120,
                    pad: 0,
                    numberTicks: 9
                },
                yaxis: {
                    label: "Sensor voltage [V]",
                    min: 0,
                    max: 2.5,
                    numberTicks: 6
                }
            },
            seriesColors: [ "#cd2820" ]
        };

        var
            degrees = 0,
            deg2rad = 3.14159265 / 180.0,
            gain = 1.0,
            a0 = [],
            firstTime = true,
            plot1;

        setInterval(function () {
            "use strict";
            $.post("scope_analog", { adref: 3.3 }, function (response) {
                var
                    data = $.parseJSON(response),
                    i;

                $('#strDate').text(data.date);
                $('#strTemp').text(data.temp);
                $('#strLED').text(data.led);

                // Added by dsmall - overwrite A0
                if (degrees > 350) {
                    degrees = 0;
                }
                // data["A0"] = Math.sin(degrees * deg2rad) * gain + 1.25;
                degrees += 10;

                // Limit to 0 to max (max + 1 points)
                if (a0.length > chartOptions.axes.xaxis.max) {
                    a0.pop();
                }
                // Add new value at beginning
                a0.unshift([0, data.A0]);
                // Adjust old X values
                for (i = 1; i < a0.length; i += 1) {
                    a0[i][0] = i;
                }

                if (firstTime) {
                    // console.log('firstTime');
                    plot1 = $.jqplot("chart1", [a0], chartOptions);
                    firstTime = false;
                } else {
                    // n += 1;
                    // console.log('replot ' + n + ': ' + a0.length);
                    // console.log(JSON.stringify(plot1.series[0].data));
                    plot1.series[0].data = a0;
                    plot1.replot();
                    // Alternative is to recreate chart
                    //plot1.destroy();
                    //plot1 = $.jqplot("chart1", [a0], chartOptions);
                }
            });
        }, 1000);

        $("#gain_up").click(function () {
            "use strict";
            gain *= 2.0;
        });

        $("#gain_down").click(function () {
            "use strict";
            gain /= 2.0;
        });
    </script>

</body>
</html>
